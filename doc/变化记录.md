# 变化记录

> 更新日期: 2026-02-27

---

## 本次优化：跨 Context 事件通信（中间类方案）

### 需求背景
- 保持现有广播方案：一个事件可能触发多个监听器
- 增加中间类：定义系统通用属性（如 parentEvent）
- 使用中间类作为通用类：CrossContextEventBridge 使用中间类处理事件
- 保留 parentEvent 属性：防止事件重复分发

---

## 1. 新增文件

| 文件 | 路径 | 描述 |
|------|------|------|
| `BaseSystemEvent.java` | common-api/src/main/java/.../model/event/ | 抽象事件基类，包含 parentEvent 属性 |
| `BaseSystemEventTest.java` | common-api/src/test/java/.../model/event/ | 基类单元测试 (3个测试) |
| `DownloadEventTest.java` | common-api/src/test/java/.../model/event/ | 事件单元测试 (3个测试) |
| `CrossContextEventBridgeTest.java` | follow-movie-web/src/test/java/.../tool/context/ | 桥接器单元测试 (5个测试) |

---

## 2. 修改的文件

### 2.1 POM 依赖修改

| 文件 | 修改内容 |
|------|----------|
| `common-api/pom.xml` | 添加 JUnit 5.10.0、Assertj 3.24.2、Mockito 5.5.0 测试依赖 |
| `follow-movie-web/pom.xml` | 添加测试依赖，修正 base-framework 依赖版本为 0.0.1-SNAPSHOT |

### 2.2 测试类修改

| 文件 | 修改内容 |
|------|----------|
| `CrossContextEventBridgeTest.java` | 添加 @MockitoSettings(strictness = Strictness.LENIENT) 注解 |

---

## 3. 类层次结构变化

```
修改前:
ApplicationEvent (Spring)
       ▲
       │
  DownloadEvent (直接继承)

修改后:
ApplicationEvent (Spring)
       ▲
       │
  BaseSystemEvent (新增 - 包含 parentEvent)
       ▲
       │
  DownloadEvent (继承 BaseSystemEvent)
```

---

## 4. 测试覆盖

### 4.1 BaseSystemEventTest (3 tests)

| 测试 | 描述 |
|------|------|
| testParentEventDefaultValue | parentEvent 默认为 false |
| testParentEventCanBeSetToTrue | parentEvent 可设置为 true |
| testSourceIsSetCorrectly | source 正确传递 |

### 4.2 DownloadEventTest (3 tests)

| 测试 | 描述 |
|------|------|
| testInheritsFromBaseSystemEvent | 继承 BaseSystemEvent |
| testConstructorSetsAllProperties | 构造函数正确设置所有属性 |
| testParentEventCanBeModified | parentEvent 可通过 setter 修改 |

### 4.3 CrossContextEventBridgeTest (5 tests)

| 测试 | 描述 |
|------|------|
| testFirstEventBroadcastsToAllChildContexts | 首次事件触发广播到所有子 Context |
| testNoBroadcastWhenParentEventIsTrue | parentEvent 为 true 时不再广播 |
| testParentEventSetToTrueAfterBroadcast | 广播后 parentEvent 被设置为 true |
| testNoExceptionWhenNoChildContexts | 空 Context 列表时不抛出异常 |
| testCanHandleAnyBaseSystemEventSubclass | 可处理任意 BaseSystemEvent 子类 |

---

## 5. Maven 测试命令

```bash
# 1. 安装 base-framework (首次)
cd /mnt/c/develop/x-project/base-framework
mvn install -DskipTests

# 2. 运行 common-api 测试
cd /mnt/c/develop/x-project/follow-movie/common-api
mvn test -Dtest=BaseSystemEventTest,DownloadEventTest

# 3. 运行 follow-movie-web 测试
cd /mnt/c/develop/x-project/follow-movie/follow-movie-web
mvn test -Dtest=CrossContextEventBridgeTest
```

---

## 6. 测试结果

```
common-api:
  Tests run: 6, Failures: 0, Errors: 0, Skipped: 0

follow-movie-web:
  Tests run: 5, Failures: 0, Errors: 0, Skipped: 0

总计: 11 tests passed
```

---

## 7. 相关文档

- [项目总结.md](./项目总结.md) - 项目公共知识
- [PUB_SUB流程.md](./PUB_SUB流程.md) - 事件发布/订阅详细流程
