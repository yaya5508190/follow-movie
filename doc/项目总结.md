# Follow-Movie 项目总结

> 最后更新: 2026-02-27

---

## 1. 项目结构

### 1.1 整体架构

```
follow-movie/
├── pom.xml                    # 父 POM (版本: 0.0.2-SNAPSHOT)
├── common-api/                # 通用 API 模块
├── common-repository/         # 数据层模块
├── follow-movie-web/          # 主应用模块
└── plugins/                   # 插件模块
    ├── media-fetch/           # 资源获取插件
    │   └── m-team/            # M-Team 站点插件
    ├── media-download/        # 下载插件
    │   ├── q-bittorrent/      # Qbittorrent 下载器
    │   └── media-download-common/
    ├── media-hub/             # 媒体中心插件
    └── pre-auth/              # 预认证插件
        └── z-space/
```

### 1.2 依赖关系

- **follow-movie-web** 依赖:
  - `common-api`
  - `common-repository`
  - `plugin-loader` (来自 base-framework)
  - `x-spider-starter` (来自 base-framework)

### 1.3 外部依赖项目

- **base-framework** (`/mnt/c/develop/x-project/base-framework/`)
  - 包含 `spring-plugin-loader` 和 `x-spider-starter`
  - 版本: `0.0.1-SNAPSHOT`

---

## 2. 跨 Context 事件通信机制

### 2.1 事件类层次结构

```java
ApplicationEvent (Spring)
       ▲
       │
  BaseSystemEvent (抽象基类 - 包含系统通用属性: parentEvent)
       ▲
       │
  DownloadEvent (业务事件 - 包含下载相关属性)
```

### 2.2 关键组件

| 组件 | 位置 | 职责 |
|------|------|------|
| `BaseSystemEvent` | common-api | 抽象基类，包含 `parentEvent` 属性 |
| `DownloadEvent` | common-api | 具体业务事件 |
| `CrossContextEventBridge` | follow-movie-web | 监听父容器事件并广播到子容器 |
| `ContextRegistry` | follow-movie-web | 管理所有子 ApplicationContext |

### 2.3 事件流转流程

```
1. 插件调用 getParent().publishEvent(event)
2. 事件发布到主 ApplicationContext
3. CrossContextEventBridge (@EventListener) 接收
4. 检查 parentEvent:
   - false: 设置为 true，广播到所有子 Context
   - true: 跳过（防止重复处理）
5. 子 Context 的监听器接收事件
```

---

## 3. 关键代码片段

### 3.1 BaseSystemEvent

```java
@Getter
@Setter
public abstract class BaseSystemEvent extends ApplicationEvent {
    private Boolean parentEvent = false;

    public BaseSystemEvent(Object source) {
        super(source);
    }
}
```

### 3.2 CrossContextEventBridge

```java
@Component
@Slf4j
public class CrossContextEventBridge {
    private final ContextRegistry contextRegistry;

    @EventListener
    public void onEvent(BaseSystemEvent event) {
        if (!event.getParentEvent()) {
            event.setParentEvent(true);
            log.info("父容器接收到事件,开始广播: {}", getEventDescription(event));
            broadcastToChildContexts(event);
        }
    }

    private void broadcastToChildContexts(BaseSystemEvent event) {
        contextRegistry.getContextMap().values().forEach(context -> {
            log.info("广播到: {}", context.getId());
            context.publishEvent(event);
        });
    }
}
```

### 3.3 核心文件路径

| 文件 | 路径 |
|------|------|
| 事件基类 | `common-api/src/main/java/com/yx/nas/model/event/BaseSystemEvent.java` |
| 事件定义 | `common-api/src/main/java/com/yx/nas/model/event/DownloadEvent.java` |
| 事件桥接 | `follow-movie-web/src/main/java/com/yx/nas/tool/context/CrossContextEventBridge.java` |
| 上下文注册 | `follow-movie-web/src/main/java/com/yx/nas/tool/context/ContextRegistry.java` |

---

## 4. 常见问题

### Q: Maven 构建失败 "Could not find artifact com.yx:plugin-loader"
A: 需要先安装 base-framework 项目: `cd /mnt/c/develop/x-project/base-framework && mvn install -DskipTests`

### Q: 子模块版本不匹配
A: 父 POM 版本为 0.0.2-SNAPSHOT，所有子模块需要统一为此版本

### Q: Mockito UnnecessaryStubbingException
A: 添加 `@MockitoSettings(strictness = Strictness.LENIENT)` 注解

---

## 5. 相关文档

- [PUB_SUB流程.md](./PUB_SUB流程.md) - 事件发布/订阅详细流程
- [变化记录.md](./变化记录.md) - 本次修改记录
